# 群组记账机器人 - 数据结构设计

## Google Sheets 工作表结构

### 1. 操作人 (Operators)
存储有权限在各个群组中操作的用户列表

| 列名 | 说明 | 示例 |
|------|------|------|
| 群组ID | Telegram 群组 ID | -1001234567890 |
| 用户ID | Telegram 用户 ID | 123456789 |
| 用户名 | 用户显示名称 | @张三 |
| 添加时间 | 添加操作人的时间 | 2024-01-01 10:00:00 |
| 状态 | 正常/已删除 | 正常 |

### 2. 入款记录 (Income)
存储所有入款交易记录

| 列名 | 说明 | 示例 |
|------|------|------|
| 记录ID | 唯一标识 | INC_20240101_001 |
| 时间戳 | 交易时间 | 2024-01-01 10:30:00 |
| 群组ID | 群组标识 | -1001234567890 |
| 操作人ID | 操作人用户ID | 123456789 |
| 操作人名 | 操作人姓名 | 张三 |
| 金额 | 入款金额 | 1000 |
| 币种 | THB/USD | THB |
| 状态 | 正常/已撤销/已删除 | 正常 |
| 原始消息ID | Telegram 消息 ID | 12345 |

### 3. 下发记录 (Outgoing)
存储所有下发交易记录

| 列名 | 说明 | 示例 |
|------|------|------|
| 记录ID | 唯一标识 | OUT_20240101_001 |
| 时间戳 | 交易时间 | 2024-01-01 11:30:00 |
| 群组ID | 群组标识 | -1001234567890 |
| 操作人ID | 操作人用户ID | 123456789 |
| 操作人名 | 操作人姓名 | 张三 |
| 金额 | 下发金额 | 500 |
| 币种 | THB/USD | USD |
| 状态 | 正常/已撤销/已删除 | 正常 |
| 原始消息ID | Telegram 消息 ID | 12346 |

### 4. 群组设置 (GroupSettings)
每个群组的配置信息

| 列名 | 说明 | 示例 |
|------|------|------|
| 群组ID | Telegram 群组 ID | -1001234567890 |
| 汇率 | THB/USD 汇率 | 35 |
| 入款费率 | 入款手续费率(%) | 25 |
| 下发费率 | 下发手续费率(%) | 0 |
| 日切时间 | 每日刷新时间(小时) | 6 |
| 所有人可用 | 是否所有人都能操作 | 否 |
| 实时汇率 | 是否使用实时汇率 | 否 |
| 最后刷新时间 | 上次日切时间 | 2024-01-01 06:00:00 |
| 禁言状态 | 是否在上课(禁言) | 否 |

### 5. 计时记录 (TimeTracking)
计时打卡记录

| 列名 | 说明 | 示例 |
|------|------|------|
| 群组ID | 群组标识 | -1001234567890 |
| 开始时间 | 打卡开始时间 | 2024-01-01 09:00:00 |
| 结束时间 | 打卡结束时间 | 2024-01-01 18:00:00 |
| 状态 | 进行中/已结束 | 进行中 |
| 累计时长(分钟) | 总时长 | 480 |

## 业务逻辑说明

### 日切逻辑
- 日切#6：每天早上6点自动删除所有账单
- 日切#0：每天晚上12点(凌晨0点)刷新
- 日切#-1：永不自动刷新，只能手动删除

### 权限验证
1. 检查群组是否设置了"所有人可用"
2. 如果不是，检查用户是否在操作人列表中
3. 特殊命令（如设置操作人）可能需要额外权限

### 金额格式
- `+1000` = 入款1000฿ (泰铢)
- `+1000$` = 入款1000$ (美元)
- `下发1000` = 下发1000฿ (泰铢)
- `下发1000$` = 下发1000$ (美元)
- `入款-1000` = 入款减少1000（错账修正）
- `下发-1000` = 下发减少1000（错账修正）

### 汇率计算
- `z100` = 将100฿泰铢转换成美元$
- 公式: USD = THB / 汇率

### 账单计算公式
- 总入款 = 所有入款之和（扣除已撤销的）
- 总下发 = 所有下发之和（扣除已撤销的）
- 实际入款 = 总入款 * (1 - 入款费率/100)
- 实际下发 = 总下发 * (1 + 下发费率/100)
- 当日盈亏 = 实际入款 - 实际下发
